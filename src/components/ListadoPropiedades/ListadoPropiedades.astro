---
import CardMain from '../Tarjetas/TarjetasPropiedades.jsx';
import Pagination from './PaginacionListadoPropiedades.jsx';
import FiltroPropiedades from './FiltroListadoPropiedades.jsx';
import Acordion from '../PreguntasFrecuentes.jsx';
import { Chip } from "@heroui/react";
import { getAllProperties } from '../../lib/properties';
import { 
  TIPOS_PROPIEDAD_VENTA, 
  TIPOS_PROPIEDAD_ALQUILER 
} from '../Buscador.jsx';
import {
  parseUrlFilters,
  filterProperties,
  calculatePagination,
  PAGE_SIZE,
  formatPrice
} from '@/utils/index.js';

// Obtener todas las propiedades
const allProperties = await getAllProperties();

// Obtener filtros de la URL
const urlFilters = parseUrlFilters(Astro.request.url);
const sortKey = urlFilters.sort || 'title_asc';

// Filtrar propiedades
const filteredProperties = filterProperties(allProperties, {
  operation: urlFilters.operation,
  city: urlFilters.city,
  propertyType: urlFilters.propertyType,
  ambientes: urlFilters.ambientes,
  search: urlFilters.search
});

// Ordenar propiedades
const sortedProperties = [...filteredProperties].sort((a, b) => {
  switch (sortKey) {
    case 'price_asc':
      return (a.data.price || 0) - (b.data.price || 0);
    case 'price_desc':
      return (b.data.price || 0) - (a.data.price || 0);
    case 'date_desc':
      return new Date(b.data.createdAt || 0).getTime() - new Date(a.data.createdAt || 0).getTime();
    case 'date_asc':
      return new Date(a.data.createdAt || 0).getTime() - new Date(b.data.createdAt || 0).getTime();
    case 'ambientes_asc':
      return (a.data.ambientes || 0) - (b.data.ambientes || 0);
    case 'ambientes_desc':
      return (b.data.ambientes || 0) - (a.data.ambientes || 0);
    case 'title_desc':
      return (b.data.title || '').localeCompare(a.data.title || '');
    case 'title_asc':
    default:
      return (a.data.title || '').localeCompare(b.data.title || '');
  }
});

// Paginación
const pagination = calculatePagination(
  sortedProperties,
  PAGE_SIZE,
  urlFilters.page || 1
);

// Generar información de paginación
const generatePaginationInfo = (pagination) => {
  const start = pagination.startIndex + 1;
  const end = Math.min(pagination.startIndex + pagination.items.length, pagination.totalItems);
  return {
    showing: `Mostrando ${start}-${end} de ${pagination.totalItems} propiedades`,
    pages: `Página ${pagination.currentPage} de ${pagination.totalPages}`
  };
};

const paginationInfo = generatePaginationInfo(pagination);

// Obtener tipos de propiedad únicos para los chips
const allTipos = [...TIPOS_PROPIEDAD_VENTA, ...TIPOS_PROPIEDAD_ALQUILER];
const uniqueTipos = allTipos.filter((tipo, index, self) =>
  index === self.findIndex((t) => (
    t.key === tipo.key
  ))
);

const pageTitle = 'Todas Nuestras Propiedades';

const pageDescription = pagination.currentPage === 1
  ? 'Explora todas las propiedades disponibles en nuestro catálogo. Encuentra tu propiedad ideal.'
  : `Página ${pagination.currentPage} de ${pagination.totalPages} de nuestro catálogo de propiedades.`;

// Schema.org para SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": pageTitle,
  "description": pageDescription,
  "numberOfItems": sortedProperties.length,
  "url": Astro.url.href,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": pagination.items.length,
    "itemListElement": pagination.items.slice(0, 10).map((property, index) => ({
      "@type": "ListItem",
      "position": pagination.startIndex + index + 1,
      "item": {
        "@type": "RealEstateListing",
        "name": property.data.title,
        "url": `/propiedades/${property.slug}`,
        "price": property.data.price ? {
          "@type": "PriceSpecification", 
          "value": property.data.price,
          "priceCurrency": property.data.currency || "USD"
        } : undefined
      }
    }))
  }
};
---

<!-- Schema.org -->
<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

<section 
  aria-labelledby="properties-title"
>
  <div class="container mx-auto">
    <!-- Header Section -->
    <header class="text-center mb-12">
      <h1 id="properties-title" class="sr-only">
        {pageTitle}
      </h1>
      <div class="flex justify-center flex-wrap gap-2 mb-4">
        {uniqueTipos.map(tipo => (
            <Chip client:load color="primary" size="sm" variant="flat">{tipo.label}</Chip>
        ))}
      </div>
      
      <!-- Información de resultados más clara -->
      {pagination.totalItems > 0 && (
        <div class="text-sm text-gray-500 space-y-1">
          <p>{paginationInfo.showing}</p>
          {pagination.totalPages > 1 && (
            <p class="text-xs">({paginationInfo.pages})</p>
          )}
        </div>
      )}
      
      <!-- Indicador de ordenamiento actual -->
      {sortKey !== 'title_asc' && (
        <Chip client:load className='mt-4' color="primary" size="sm">
          Ordenado por: {(() => {
            const sortLabels = {
              'price_asc': 'Precio: menor a mayor',
              'price_desc': 'Precio: mayor a menor', 
              'date_desc': 'Más recientes',
              'date_asc': 'Más antiguos',
              'title_desc': 'Título Z-A',
              'ambientes_asc': 'Ambientes: menor a mayor',
              'ambientes_desc': 'Ambientes: mayor a menor'
            };
            return sortLabels[sortKey] || 'Personalizado';
          })()}
       </Chip>
      )}
    </header>

    <!-- Filtros -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
      <!-- Estadísticas rápidas -->
      <div class="text-sm text-gray-500">
        {allProperties.length !== sortedProperties.length && (
          <span>Mostrando: <span class="font-medium text-gray-900">{sortedProperties.length}</span> de {allProperties.length}</span>
        )}
      </div>
      
      <!-- Componente de filtros -->
      <div class="w-full sm:w-auto">
        <FiltroPropiedades client:load />
      </div>
    </div>

    {pagination.items.length > 0 ? (
      <>
        <!-- Properties Grid -->
        <div 
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8"
          role="list"
          aria-label="Lista de propiedades"
        >
          {pagination.items.map((property, index) => {
            const globalIndex = pagination.startIndex + index;
            const isAboveFold = globalIndex < 4; // Primeras 4 propiedades
            
            return (
              <div role="listitem" key={property.slug || `property-${index}`}>
                <CardMain 
                  client:load
                  image={property.data?.image} 
                  title={property.data?.title || 'Título no disponible'} 
                  description={property.data?.description || 'Descripción no disponible'} 
                  price={formatPrice(property.data?.price, property.data?.currency)}
                  slug={property.slug}
                  imageAlt={`Imagen de ${property.data?.title || 'propiedad'}`}
                  priority={isAboveFold}
                  loading={isAboveFold ? 'eager' : 'lazy'}
                />
              </div>
            );
          })}
        </div>

        <!-- Pagination -->
        {pagination.totalPages > 1 && (
          <nav class="mt-12 flex justify-center" aria-label="Navegación de páginas">
            <Pagination 
              client:load 
              initialPage={pagination.currentPage} 
              total={pagination.totalPages} 
              basePath="/propiedades"
            />
          </nav>
        )}
        
        <!-- Links de navegación para SEO -->
        {pagination.totalPages > 1 && (
          <div class="hidden">
            {pagination.hasPrev && (
              <link rel="prev" href={`/propiedades?page=${pagination.currentPage - 1}${sortKey !== 'title_asc' ? `&sort=${sortKey}` : ''}`} />
            )}
            {pagination.hasNext && (
              <link rel="next" href={`/propiedades?page=${pagination.currentPage + 1}${sortKey !== 'title_asc' ? `&sort=${sortKey}` : ''}`} />
            )}
          </div>
        )}
      </>
    ) : (
      <!-- Empty State mejorado -->
      <div class="text-center py-12" role="status">
        <div class="max-w-md mx-auto">
          <!-- Ícono de estado vacío -->
          <div class="mx-auto w-24 h-24 mb-6 text-gray-300">
            <svg fill="currentColor" viewBox="0 0 24 24" class="w-full h-full">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
          </div>
          
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            No hay propiedades disponibles
          </h3>
          <p class="text-gray-500 mb-6">
            {allProperties.length === 0 
              ? 'Estamos trabajando para agregar nuevas propiedades pronto.'
              : sortedProperties.length === 0
              ? 'No se encontraron propiedades que coincidan con los criterios de búsqueda.'
              : 'No se encontraron propiedades en esta página.'
            }
          </p>
          
          <div class="space-y-2">
            {pagination.currentPage > 1 && (
              <a 
                href="/propiedades" 
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
              >
                Volver a la primera página
              </a>
            )}
            
            {sortKey !== 'title_asc' && (
              <div class="text-center">
                <a 
                  href="/propiedades" 
                  class="text-sm text-gray-500 hover:text-gray-700 underline"
                >
                  Ver todas las propiedades sin filtros
                </a>
              </div>
            )}
          </div>
        </div>
      </div>
    )}
  </div>
</section>

<!-- Preguntas Frecuentes -->
<Acordion client:load />

<style>
  /* Mejoras de performance y UX */
  .container {
    contain: layout style;
  }
  
  /* Responsive improvements */
  @media (max-width: 640px) {
    .grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .text-4xl {
      font-size: 2rem;
    }
  }
</style>