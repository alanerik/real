---
import Layout from "../../layouts/Layout.astro";
import TenantDashboard from "../../components/tenant/TenantDashboard";
---

<Layout title="Mi Portal - Dashboard">
    <div class="min-h-screen bg-gray-50">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">
                            Mi Portal
                        </h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tenant-name" class="text-sm text-gray-600"
                        ></span>
                        <button
                            id="logout-btn"
                            class="text-sm text-gray-500 hover:text-gray-700"
                        >
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <TenantDashboard client:only="react" />
        </main>
    </div>
</Layout>

<script>
    import { supabase } from "../../lib/supabase";
    import { getTenantRental } from "../../lib/auth-tenant";

    const logoutBtn = document.getElementById("logout-btn");
    const tenantNameEl = document.getElementById("tenant-name");

    // Check Auth
    const checkUser = async () => {
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            window.location.href = "/tenant/login";
            return;
        }

        // Verify user is a tenant
        try {
            const rental = await getTenantRental();
            if (tenantNameEl) {
                tenantNameEl.textContent =
                    rental.tenant_name || session.user.email;
            }
        } catch (error) {
            console.error("Not a tenant:", error);
            await supabase.auth.signOut();
            window.location.href = "/tenant/login";
        }
    };

    checkUser();

    // Logout
    logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "/tenant/login";
    });
</script>
